<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appraisal Orders</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDHqA52DEjw6hBLLbshcNXACDYBGgXAPlE&libraries=places"></script>
    <script src="https://alcdn.msauth.net/browser/2.38.1/js/msal-browser.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>
    <script>
        function createGoogleCalendarLink(order) {
            if (!order.startDate || !order.startTime) return '#';
            
            const startDateTime = order.startDate + 'T' + order.startTime + ':00';
            const startDate = new Date(startDateTime);
            const endDate = new Date(startDate.getTime() + 60 * 60 * 1000);
            
            const formatGoogleDate = (date) => {
                return date.toISOString().replace(/-|:|\.\d+/g, '');
            };
            
            const title = encodeURIComponent('Inspection: ' + order.addr);
            const details = encodeURIComponent([
                'Order #: ' + (order.num || ''),
                'Client: ' + (order.client || ''),
                'Borrower: ' + (order.borrower || ''),
                'POC: ' + (order.poc || ''),
                'Phone: ' + (order.phone || ''),
                'Email: ' + (order.email || ''),
                'Loan #: ' + (order.loan || '')
            ].filter(Boolean).join('\n'));
            const location = encodeURIComponent(order.addr || '');
            const dates = formatGoogleDate(startDate) + '/' + formatGoogleDate(endDate);
            
            return `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&details=${details}&location=${location}&dates=${dates}`;
        }

        function formatPhone(value) {
            const numbers = value.replace(/\D/g, '');
            if (numbers.length <= 3) {
                return numbers;
            } else if (numbers.length <= 6) {
                return `(${numbers.slice(0, 3)}) ${numbers.slice(3)}`;
            } else {
                return `(${numbers.slice(0, 3)}) ${numbers.slice(3, 6)}-${numbers.slice(6, 10)}`;
            }
        }

        // Microsoft Authentication Configuration
        const msalConfig = {
            auth: {
                clientId: '89d0320b-597e-4405-8ccd-7beeb8e25566',
                authority: 'https://login.microsoftonline.com/consumers',
                redirectUri: 'https://bgoheen.github.io/orders'
            },
            cache: {
                cacheLocation: 'localStorage',
                storeAuthStateInCookie: false
            }
        };

        const msalInstance = new msal.PublicClientApplication(msalConfig);
        let msalAccount = null;
        let accessToken = null;

        const loginRequest = {
            scopes: ['Files.ReadWrite', 'User.Read', 'offline_access']
        };

        // Initialize MSAL
        msalInstance.initialize().then(() => {
            msalInstance.handleRedirectPromise().then(async response => {
                if (response) {
                    msalAccount = response.account;
                    await getAccessToken();
                    await loadOrdersFromOneDrive();
                    
                    if (window.opener && !window.opener.closed) {
                        window.opener.postMessage('auth-complete', '*');
                        window.close();
                    }
                } else {
                    const accounts = msalInstance.getAllAccounts();
                    if (accounts.length > 0) {
                        msalAccount = accounts[0];
                        await getAccessToken();
                        await loadOrdersFromOneDrive();
                    }
                }
                
                render();
            }).catch(err => {
                console.error('MSAL error:', err);
                render();
            });
        });

        window.addEventListener('message', (event) => {
            if (event.data === 'auth-complete') {
                window.location.reload();
            }
        });

        async function signIn() {
            try {
                await msalInstance.loginPopup(loginRequest);
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length > 0) {
                    msalAccount = accounts[0];
                    await getAccessToken();
                    await loadOrdersFromOneDrive();
                    render();
                }
            } catch (error) {
                console.error('Login error:', error);
            }
        }

        async function getAccessToken() {
            const request = {
                ...loginRequest,
                account: msalAccount
            };

            try {
                const response = await msalInstance.acquireTokenSilent(request);
                accessToken = response.accessToken;
                return accessToken;
            } catch (error) {
                if (error instanceof msal.InteractionRequiredAuthError) {
                    const response = await msalInstance.acquireTokenPopup(request);
                    accessToken = response.accessToken;
                    return accessToken;
                }
                throw error;
            }
        }

        async function uploadToOneDrive(file, orderId) {
            if (!accessToken) {
                await getAccessToken();
            }

            const fileName = `${orderId}_${file.name}`;
            const uploadUrl = `https://graph.microsoft.com/v1.0/me/drive/root:/AppraisalOrders/${fileName}:/content`;

            try {
                const response = await fetch(uploadUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': file.type
                    },
                    body: file
                });

                if (response.ok) {
                    const result = await response.json();
                    return {
                        id: result.id,
                        name: file.name,
                        date: new Date().toLocaleDateString(),
                        size: file.size,
                        webUrl: result.webUrl,
                        downloadUrl: result['@microsoft.graph.downloadUrl']
                    };
                } else {
                    throw new Error('Upload failed: ' + response.statusText);
                }
            } catch (error) {
                console.error('OneDrive upload error:', error);
                throw error;
            }
        }

        async function downloadFromOneDrive(fileId) {
            if (!accessToken) {
                await getAccessToken();
            }

            try {
                const response = await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${fileId}`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                const fileInfo = await response.json();
                if (fileInfo['@microsoft.graph.downloadUrl']) {
                    window.open(fileInfo['@microsoft.graph.downloadUrl'], '_blank');
                }
            } catch (error) {
                console.error('Download error:', error);
            }
        }

        function downloadFile(file) {
            if (file.downloadUrl) {
                window.open(file.downloadUrl, '_blank');
            } else if (file.webUrl) {
                window.open(file.webUrl, '_blank');
            }
        }

        async function deleteFromOneDrive(fileId) {
            if (!accessToken) {
                await getAccessToken();
            }

            try {
                await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${fileId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
            } catch (error) {
                console.error('Delete error:', error);
                throw error;
            }
        }

        async function saveOrdersToOneDrive() {
            if (!accessToken) {
                await getAccessToken();
            }

            const ordersJson = JSON.stringify(data.orders, null, 2);
            const blob = new Blob([ordersJson], { type: 'application/json' });

            try {
                const response = await fetch('https://graph.microsoft.com/v1.0/me/drive/root:/AppraisalOrders/orders.json:/content', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: blob
                });

                if (!response.ok) {
                    throw new Error('Failed to save to OneDrive: ' + response.statusText);
                }
            } catch (error) {
                console.error('OneDrive save error:', error);
                throw error;
            }
        }

        async function loadOrdersFromOneDrive() {
            if (!accessToken) {
                await getAccessToken();
            }

            try {
                const response = await fetch('https://graph.microsoft.com/v1.0/me/drive/root:/AppraisalOrders/orders.json:/content', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (response.ok) {
                    const ordersData = await response.json();
                    
                    const localOrders = JSON.parse(localStorage.getItem('orders') || '[]');
                    const lastSync = localStorage.getItem('lastOneDriveSync');
                    const localModified = localStorage.getItem('localModified');
                    
                    if (localModified && lastSync && parseInt(localModified) > parseInt(lastSync)) {
                        console.log('Local changes detected - keeping local data and syncing to OneDrive...');
                        data.orders = localOrders;
                        await saveOrdersToOneDrive();
                    } else {
                        data.orders = ordersData;
                        localStorage.setItem('orders', JSON.stringify(data.orders));
                        localStorage.setItem('lastOneDriveSync', Date.now().toString());
                        console.log('Orders loaded from OneDrive:', data.orders.length, 'orders');
                    }
                    render();
                } else if (response.status === 404) {
                    console.log('No orders file in OneDrive yet, using localStorage');
                } else {
                    throw new Error('Failed to load from OneDrive: ' + response.statusText);
                }
            } catch (error) {
                console.error('OneDrive load error:', error);
            }
        }

        const data = {
            orders: JSON.parse(localStorage.getItem('orders') || '[]'),
            clients: JSON.parse(localStorage.getItem('clients') || '["Members", "Temple View"]'),
            view: 'list',
            selected: null,
            showNew: false,
            editing: false,
            collapsed: {COMPLETED: true, CANCELLED: true},
            sortBy: 'dueDate',
            sortDir: 'asc'
        };

        async function save() {
            localStorage.setItem('orders', JSON.stringify(data.orders));
            localStorage.setItem('localModified', Date.now().toString());
            console.log('Orders saved to localStorage:', data.orders.length, 'orders');
            
            if (msalAccount && accessToken) {
                try {
                    await saveOrdersToOneDrive();
                    localStorage.setItem('lastOneDriveSync', Date.now().toString());
                } catch (error) {
                    console.error('Failed to sync to OneDrive:', error);
                }
            }
        }

        function saveClients() {
            localStorage.setItem('clients', JSON.stringify(data.clients));
        }

        function genNumber() {
            const year = new Date().getFullYear();
            const existing = data.orders
                .map(o => o.num)
                .filter(num => num && num.startsWith(year + '-'))
                .map(num => parseInt(num.split('-')[1]))
                .filter(n => !isNaN(n));
            
            const maxNum = existing.length > 0 ? Math.max(...existing) : 0;
            const nextNum = String(maxNum + 1).padStart(3, '0');
            return `${year}-${nextNum}`;
        }

        function formatDate(d) {
            if (!d) return '-';
            // Parse as local date to avoid timezone issues
            const [year, month, day] = d.split('-');
            const date = new Date(year, month - 1, day);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function formatDateTime(d, t) {
            if (!d) return '-';
            // Parse as local date to avoid timezone issues
            const [year, month, day] = d.split('-');
            const date = new Date(year, month - 1, day);
            const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            if (!t) return dateStr;
            
            const [hours, minutes] = t.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour % 12 || 12;
            return `${dateStr}, ${displayHour}:${minutes} ${ampm}`;
        }

        function formatFullDateTime(d, t) {
            if (!d || !t) return '';
            // Parse as local date to avoid timezone issues
            const [year, month, day] = d.split('-');
            const date = new Date(year, month - 1, day);
            const dateStr = date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            const [hours, minutes] = t.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour % 12 || 12;
            return `${dateStr} at ${displayHour}:${minutes.padStart(2, '0')} ${ampm}`;
        }

        function initAutocomplete(inputId) {
            setTimeout(() => {
                const input = document.getElementById(inputId);
                if (input) {
                    google.maps.event.clearInstanceListeners(input);
                }
                if (typeof google !== 'undefined' && google.maps && google.maps.places) {
                    const autocomplete = new google.maps.places.Autocomplete(input, {
                        types: ['address'],
                        componentRestrictions: { country: 'us' }
                    });
                }
            }, 100);
        }

        function openMap(addr) {
            window.open('https://www.google.com/maps/dir/?api=1&destination=' + encodeURIComponent(addr), '_blank');
        }

        function copyToClipboard(e, text, fieldName) {
            e.preventDefault();
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    const btn = e.target.closest('button');
                    if (!btn) return;
                    
                    const originalHTML = btn.innerHTML;
                    btn.innerHTML = '✓';
                    btn.classList.remove('bg-gray-200', 'hover:bg-gray-300');
                    btn.classList.add('bg-green-500', 'text-white');
                    
                    setTimeout(() => {
                        btn.innerHTML = originalHTML;
                        btn.classList.remove('bg-green-500', 'text-white');
                        btn.classList.add('bg-gray-200', 'hover:bg-gray-300');
                    }, 2000);
                }).catch((err) => {
                    console.error('Clipboard API failed:', err);
                    fallbackCopy(e, text, fieldName);
                });
            } else {
                fallbackCopy(e, text, fieldName);
            }
        }
        
        function fallbackCopy(e, text, fieldName) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                const btn = e.target.closest('button');
                if (btn) {
                    const originalHTML = btn.innerHTML;
                    btn.innerHTML = '✓';
                    btn.classList.remove('bg-gray-200', 'hover:bg-gray-300');
                    btn.classList.add('bg-green-500', 'text-white');
                    
                    setTimeout(() => {
                        btn.innerHTML = originalHTML;
                        btn.classList.remove('bg-green-500', 'text-white');
                        btn.classList.add('bg-gray-200', 'hover:bg-gray-300');
                    }, 2000);
                }
            } catch (err) {
                console.error('Fallback copy failed:', err);
                alert('Failed to copy');
            } finally {
                document.body.removeChild(textarea);
            }
        }

        function render() {
            document.getElementById('app').innerHTML = `
                <div class="h-screen flex flex-col bg-gray-50">
                    <!-- Header -->
                    <div class="bg-white border-b px-8 py-5 flex justify-between items-center">
                        <img src="metrowide-logo.png" alt="Metrowide Appraisals" class="h-10">
                        <div class="flex gap-3 items-center">
                            ${msalAccount ? `
                                <div class="flex items-center gap-2 px-3 py-2 text-sm text-gray-600">
                                    <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    OneDrive
                                </div>
                            ` : `
                                <button onclick="signIn()" class="px-4 py-2 text-sm text-gray-700 hover:text-gray-900">Sign in to OneDrive</button>
                            `}
                            <button onclick="data.showNew = true; render()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">+ New Order</button>
                        </div>
                    </div>
                    
                    <!-- Main Content -->
                    <div class="flex-1 overflow-hidden">
                        ${renderList()}
                    </div>
                    
                    ${data.selected ? renderDetail() : ''}
                    ${data.showNew ? renderNewModal() : ''}
                </div>
            `;
            
            if (data.showNew) {
                initAutocomplete('new-addr');
            }
        }

        function renderList() {
            const sortOrders = (orders) => {
                return [...orders].sort((a, b) => {
                    const field = data.sortBy;
                    const aVal = field === 'startDate' ? (a.startDate || '') : (a.dueDate || '');
                    const bVal = field === 'startDate' ? (b.startDate || '') : (b.dueDate || '');
                    
                    if (!aVal) return 1;
                    if (!bVal) return -1;
                    
                    const comparison = new Date(aVal) - new Date(bVal);
                    return data.sortDir === 'asc' ? comparison : -comparison;
                });
            };
            
            const groups = {
                ORDERED: sortOrders(data.orders.filter(o => o.stat === 'ORDERED')),
                COMPLETED: sortOrders(data.orders.filter(o => o.stat === 'COMPLETED')),
                CANCELLED: sortOrders(data.orders.filter(o => o.stat === 'CANCELLED'))
            };

            const statusConfig = {
                ORDERED: { color: 'bg-orange-500', textColor: 'text-orange-700', bgLight: 'bg-[#FFF0DF]' },
                COMPLETED: { color: 'bg-green-500', textColor: 'text-green-700', bgLight: 'bg-[#EDF9EE]' },
                CANCELLED: { color: 'bg-gray-400', textColor: 'text-gray-700', bgLight: 'bg-[#EDEDEE]' }
            };

            return `<div class="flex-1 overflow-y-auto px-8 py-6">
                <div class="max-w-6xl mx-auto">
                ${Object.entries(groups).map(([stat, orders]) => {
                    const config = statusConfig[stat];
                    return `
                    <div class="mb-8">
                        <button onclick="toggleCollapse('${stat}')" class="flex items-center gap-3 mb-4 group">
                            <span class="text-gray-400 group-hover:text-gray-600 transition-colors">${data.collapsed[stat] ? '▶' : '▼'}</span>
                            <div class="flex items-center gap-2 px-3 py-1.5 ${config.bgLight} rounded-full">
                                <span class="w-2 h-2 ${config.color} rounded-full"></span>
                                <span class="text-sm font-medium ${config.textColor} uppercase tracking-wide">${stat}</span>
                            </div>
                            <span class="text-sm text-gray-500">${orders.length} order${orders.length !== 1 ? 's' : ''}</span>
                        </button>
                        
                        ${!data.collapsed[stat] && orders.length > 0 ? `
                            <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                                <table class="w-full">
                                    <thead class="bg-gray-50 border-b border-gray-200">
                                        <tr class="text-left">
                                            <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Address</th>
                                            <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:text-gray-700" onclick="sortBy('startDate')">
                                                Start ${data.sortBy === 'startDate' ? (data.sortDir === 'asc' ? '↑' : '↓') : ''}
                                            </th>
                                            <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:text-gray-700" onclick="sortBy('dueDate')">
                                                Due ${data.sortBy === 'dueDate' ? (data.sortDir === 'asc' ? '↑' : '↓') : ''}
                                            </th>
                                            <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Client</th>
                                            <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Order</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200">
                                        ${orders.map(o => `
                                            <tr class="cursor-pointer transition-colors ${
                                                data.selected?.id === o.id ? 'bg-blue-50' : 
                                                o.fha ? 'bg-yellow-50' : ''
                                            }" 
                                            style="transition: background-color 0.15s ease;"
                                            onmouseover="this.style.backgroundColor='#F7F9FF'" 
                                            onmouseout="this.style.backgroundColor='${data.selected?.id === o.id ? '#eff6ff' : o.fha ? '#fefce8' : 'transparent'}'"
                                            onclick="selectOrder(${o.id})">
                                                <td class="px-6 py-4">
                                                    <div class="text-sm font-medium text-gray-900">${o.addr}</div>
                                                </td>
                                                <td class="px-6 py-4 text-sm text-gray-600">${formatDateTime(o.startDate, o.startTime)}</td>
                                                <td class="px-6 py-4 text-sm text-gray-600">${formatDate(o.dueDate)}</td>
                                                <td class="px-6 py-4 text-sm text-gray-600">${o.client || '-'}</td>
                                                <td class="px-6 py-4">
                                                    <div class="flex items-center gap-3">
                                                        <span class="text-sm text-gray-600">${o.num}</span>
                                                        <button onclick="event.stopPropagation(); openMap('${o.addr.replace(/'/g, "\\'")}')" 
                                                           class="opacity-50 hover:opacity-100 transition-opacity flex-shrink-0"
                                                           title="Open in Google Maps">
                                                            <img src="map-pin.png" alt="Map" class="w-5 h-5 object-contain">
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : ''}
                    </div>
                `;
                }).join('')}
                </div>
            </div>`;
        }

        function toggleCollapse(s) { data.collapsed[s] = !data.collapsed[s]; render(); }
        
        function sortBy(field) {
            if (data.sortBy === field) {
                data.sortDir = data.sortDir === 'asc' ? 'desc' : 'asc';
            } else {
                data.sortBy = field;
                data.sortDir = 'asc';
            }
            render();
        }

        function selectOrder(id) {
            data.selected = data.orders.find(o => o.id === id);
            data.editing = false;
            render();
        }

        function updateField(field, value) {
            if (data.selected) {
                data.selected[field] = value;
                const idx = data.orders.findIndex(o => o.id === data.selected.id);
                if (idx !== -1) {
                    data.orders[idx] = data.selected;
                }
                save();
                render();
            }
        }

        function saveEdit() {
            const idx = data.orders.findIndex(o => o.id === data.selected.id);
            if (idx !== -1) {
                data.orders[idx] = data.selected;
            }
            save();
            data.editing = false;
            render();
        }

        function renderDetail() {
            const o = data.selected;
            
            const statusConfig = {
                ORDERED: { bg: 'bg-[#FFA00A]', text: 'text-white', bgLight: 'bg-[#FFF0DF]', textLight: 'text-[#FFA00A]' },
                COMPLETED: { bg: 'bg-[#22C55E]', text: 'text-white', bgLight: 'bg-[#EDF9EE]', textLight: 'text-[#22C55E]' },
                CANCELLED: { bg: 'bg-[#9CA3AF]', text: 'text-white', bgLight: 'bg-[#EDEDEE]', textLight: 'text-[#9CA3AF]' }
            };
            
            return `
                <!-- Blurred Overlay -->
                <div class="fixed inset-0 bg-gray-900 bg-opacity-40 backdrop-blur-sm z-40" onclick="data.selected = null; render();"></div>
                
                <!-- Centered Detail Popup -->
                <div class="fixed inset-0 z-50 flex items-center justify-center p-4" onclick="if(event.target === event.currentTarget) { data.selected = null; render(); }">
                    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col" onclick="event.stopPropagation();">
                        <!-- Header -->
                        <div class="px-8 py-6 border-b border-gray-200">
                            <h2 class="text-xl font-semibold text-gray-900">${o.addr}</h2>
                        </div>
                        
                        <!-- Scrollable Content -->
                        <div class="flex-1 overflow-y-auto px-8 py-6 space-y-6">
                            <!-- Status Buttons - Full Width -->
                            <div class="grid grid-cols-3 gap-3">
                                ${['ORDERED', 'COMPLETED', 'CANCELLED'].map(status => {
                                    const config = statusConfig[status];
                                    const isActive = o.stat === status;
                                    return `
                                        <button onclick="updateField('stat', '${status}')" 
                                            class="px-8 py-3 rounded-lg font-medium transition-all ${
                                                isActive 
                                                    ? `${config.bg} ${config.text} shadow-md` 
                                                    : `${config.bgLight} ${config.textLight} hover:shadow-sm`
                                            }">
                                            ${status === 'ORDERED' ? 'Ordered' : status === 'COMPLETED' ? 'Completed' : 'Cancelled'}
                                        </button>
                                    `;
                                }).join('')}
                            </div>
                        
                        <!-- Calendar Button -->
                        ${o.startDate && o.startTime ? `
                            <div class="pt-4 border-t border-gray-200">
                                <a href="${createGoogleCalendarLink(o)}" 
                                   target="_blank"
                                   class="flex items-center justify-center gap-2 w-full px-5 py-3 bg-gray-50 text-[#006EE4] rounded-lg hover:bg-gray-100 transition-colors font-medium">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    Add to Google Calendar
                                </a>
                            </div>
                        ` : ''}
                        
                        <!-- Schedule Section -->
                        <div class="pt-6">
                            <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-4">Schedule</h3>
                            <div class="bg-gray-50 rounded-xl p-4 space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Start</span>
                                    <span class="text-sm font-medium text-gray-900">${o.startDate && o.startTime ? formatFullDateTime(o.startDate, o.startTime) : 'Not set'}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Due</span>
                                    <span class="text-sm font-medium text-gray-900">${o.dueDate ? formatDate(o.dueDate) + ', ' + new Date(o.dueDate).getFullYear() : 'Not set'}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Client & Order Info -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs font-semibold text-gray-500 uppercase tracking-wider block mb-2">Client</label>
                                <div class="bg-gray-50 rounded-lg px-4 py-3">
                                    <span class="text-sm text-gray-900">${o.client || '-'}</span>
                                </div>
                            </div>
                            <div>
                                <label class="text-xs font-semibold text-gray-500 uppercase tracking-wider block mb-2">Order Number</label>
                                <div class="bg-gray-50 rounded-lg px-4 py-3 flex justify-between items-center">
                                    <span class="text-sm text-gray-900">${o.num}</span>
                                    ${o.num ? `
                                        <button onclick="copyToClipboard(event, '${o.num}', 'Order #')" 
                                            class="text-xs px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded">
                                            Copy
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Point of Contact Section -->
                        <div class="pt-6">
                            <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-4">Point of Contact</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="text-xs text-gray-600 block mb-1.5">Name</label>
                                    <div class="bg-gray-50 rounded-lg px-4 py-3">
                                        <span class="text-sm text-gray-900">${o.poc || '-'}</span>
                                    </div>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-600 block mb-1.5">Phone</label>
                                    <div class="bg-gray-50 rounded-lg px-4 py-3 flex justify-between items-center">
                                        <span class="text-sm text-gray-900">${o.phone || '-'}</span>
                                        ${o.phone ? `
                                            <button onclick="copyToClipboard(event, '${o.phone}', 'Phone')" 
                                                class="text-xs px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded">
                                                Copy
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-600 block mb-1.5">Email</label>
                                    <div class="bg-gray-50 rounded-lg px-4 py-3">
                                        <span class="text-sm text-gray-900">${o.email || '-'}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Borrower -->
                        <div>
                            <label class="text-xs text-gray-600 block mb-1.5">Borrower(s)</label>
                            <input type="text" value="${o.borrower || ''}" 
                                onchange="updateField('borrower', this.value)"
                                placeholder="Enter borrower name(s)"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                        </div>
                        
                        <!-- Loan Number & FHA -->
                        <div class="flex gap-3 items-end">
                            <div class="flex-1">
                                <label class="text-xs text-gray-600 block mb-1.5">Loan Number</label>
                                <input type="text" value="${o.loan || ''}" 
                                    onchange="updateField('loan', this.value)"
                                    placeholder="Enter loan number"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                            </div>
                            <div class="pb-3">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" ${o.fha ? 'checked' : ''} 
                                           onchange="updateField('fha', this.checked)"
                                           class="w-4 h-4 text-blue-600 rounded">
                                    <span class="text-sm text-gray-700 font-medium">FHA</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Description -->
                        <div>
                            <label class="text-xs text-gray-600 block mb-1.5">Description</label>
                            <textarea onchange="updateField('desc', this.value)" 
                                placeholder="Add notes or description"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm min-h-[100px]">${o.desc || ''}</textarea>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div class="px-8 py-4 border-t border-gray-200 flex justify-between items-center">
                        <button onclick="deleteOrder(${o.id})" 
                            class="px-4 py-2 text-red-600 hover:text-red-700 hover:bg-red-50 rounded-lg transition-colors font-medium">
                            Delete
                        </button>
                        <div class="flex gap-3">
                            <button onclick="data.selected = null; render()" 
                                class="px-6 py-2 text-gray-700 hover:text-gray-900 rounded-lg hover:bg-gray-100 transition-colors font-medium">
                                Cancel
                            </button>
                            <button onclick="saveEdit()" 
                                class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium transition-colors">
                                Save
                            </button>
                        </div>
                    </div>
                </div>
                </div>
            `;
        }

        function renderNewModal() {
            return `
                <div class="fixed inset-0 bg-gray-900 bg-opacity-40 backdrop-blur-sm z-50 flex items-center justify-center p-4" onclick="data.showNew = false; render();">
                    <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col shadow-2xl" onclick="event.stopPropagation();">
                        <!-- Header -->
                        <div class="px-8 py-6 border-b border-gray-200">
                            <h2 class="text-2xl font-semibold text-gray-900">New Order</h2>
                        </div>
                        
                        <!-- Form Content -->
                        <div class="flex-1 overflow-y-auto px-8 py-6 space-y-4">
                            <div>
                                <label class="text-xs font-semibold text-gray-500 uppercase tracking-wider block mb-2">
                                    Address <span class="text-red-500">*</span>
                                </label>
                                <input type="text" id="new-addr" 
                                    placeholder="Start typing for suggestions"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs text-gray-600 block mb-1.5">Start Date</label>
                                    <input type="date" id="new-startDate" onfocus="this.showPicker()"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-600 block mb-1.5">Start Time</label>
                                    <input type="time" id="new-startTime"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                                </div>
                            </div>
                            
                            <div>
                                <label class="text-xs text-gray-600 block mb-1.5">Due Date</label>
                                <input type="date" id="new-dueDate" onfocus="this.showPicker()"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                            </div>
                            
                            <div>
                                <label class="text-xs text-gray-600 block mb-1.5">Client</label>
                                <select id="new-client"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                                    <option value="">Select client...</option>
                                    ${data.clients.map(c => `<option value="${c}">${c}</option>`).join('')}
                                    <option value="__ADD_NEW__">+ Add New Client</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="text-xs text-gray-600 block mb-1.5">Borrower(s)</label>
                                <input type="text" id="new-borrower" 
                                    placeholder="Enter borrower name(s)"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                            </div>
                            
                            <div>
                                <label class="text-xs text-gray-600 block mb-1.5">POC Name</label>
                                <input type="text" id="new-poc" 
                                    placeholder="Point of contact"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs text-gray-600 block mb-1.5">POC Phone</label>
                                    <input type="tel" id="new-phone" 
                                        placeholder="(612) 555-5555"
                                        oninput="this.value = formatPhone(this.value)"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-600 block mb-1.5">POC Email</label>
                                    <input type="email" id="new-email" 
                                        placeholder="email@example.com"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                                </div>
                            </div>
                            
                            <div class="flex gap-3 items-end">
                                <div class="flex-1">
                                    <label class="text-xs text-gray-600 block mb-1.5">Loan Number</label>
                                    <input type="text" id="new-loan" 
                                        placeholder="Enter loan number"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                                </div>
                                <div class="pb-3">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" id="new-fha" class="w-4 h-4 text-blue-600 rounded">
                                        <span class="text-sm text-gray-700 font-medium">FHA</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Footer -->
                        <div class="px-8 py-6 border-t border-gray-200 flex gap-3 justify-end">
                            <button onclick="data.showNew = false; render()" 
                                class="px-6 py-2.5 text-gray-700 hover:text-gray-900 rounded-lg hover:bg-gray-100 transition-colors font-medium">
                                Cancel
                            </button>
                            <button onclick="createOrder()" 
                                class="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium transition-colors">
                                Create Order
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function createOrder() {
            const addr = document.getElementById('new-addr').value;
            if (!addr) { alert('Address required'); return; }
            
            const newOrder = {
                id: Date.now(),
                name: addr,
                stat: 'ORDERED',
                fha: document.getElementById('new-fha').checked,
                startDate: document.getElementById('new-startDate').value,
                startTime: document.getElementById('new-startTime').value,
                dueDate: document.getElementById('new-dueDate').value,
                addr,
                client: document.getElementById('new-client').value,
                borrower: document.getElementById('new-borrower').value,
                poc: document.getElementById('new-poc').value,
                phone: document.getElementById('new-phone').value,
                email: document.getElementById('new-email').value,
                loan: document.getElementById('new-loan').value,
                num: genNumber(),
                desc: '',
                att: []
            };
            
            data.orders.push(newOrder);
            save();
            data.showNew = false;
            render();
        }

        async function deleteOrder(id) {
            if (confirm('Delete this order?')) {
                const order = data.orders.find(o => o.id === id);
                console.log('Deleting order:', order);
                
                data.orders = data.orders.filter(o => o.id !== id);
                save();
                data.selected = null;
                render();
            }
        }

        // Clean up old Google Calendar tokens if they exist
        localStorage.removeItem('googleAccessToken');
        localStorage.removeItem('googleTokenExpiry');

        render();
    </script>
</body>
</html>
