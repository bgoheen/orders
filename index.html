<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appraisal Orders</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDHqA52DEjw6hBLLbshcNXACDYBGgXAPlE&libraries=places,visualization"></script>
    <script src="https://alcdn.msauth.net/browser/2.38.1/js/msal-browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        /* Smooth transitions */
        .transition-all {
            transition: all 0.2s ease;
        }
        
        /* Card hover effect */
        .order-card {
            transition: all 0.15s ease;
        }
        
        .order-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        /* Status badge styles */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            padding: 2px 8px;
            border-radius: 6px;
        }
        
        .status-ordered {
            background-color: #FEF3C7;
            color: #92400E;
        }
        
        .status-completed {
            background-color: #D1FAE5;
            color: #065F46;
        }
        
        .status-cancelled {
            background-color: #FEE2E2;
            color: #991B1B;
        }
        
        /* Map container */
        #map {
            height: 500px;
            border-radius: 12px;
            overflow: hidden;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>
    <script>
        let map = null;
        let markers = [];
        let heatmap = null;
        
        function createGoogleCalendarLink(order) {
            if (!order.startDate || !order.startTime) return '#';
            
            const startDateTime = order.startDate + 'T' + order.startTime + ':00';
            const startDate = new Date(startDateTime);
            const endDate = new Date(startDate.getTime() + 60 * 60 * 1000);
            
            const formatGoogleDate = (date) => {
                return date.toISOString().replace(/-|:|\.\d+/g, '');
            };
            
            const title = encodeURIComponent('Inspection: ' + order.addr);
            const details = encodeURIComponent([
                'Order #: ' + (order.num || ''),
                'Client: ' + (order.client || ''),
                'Borrower: ' + (order.borrower || ''),
                'POC: ' + (order.poc || ''),
                'Phone: ' + (order.phone || ''),
                'Email: ' + (order.email || ''),
                'Loan #: ' + (order.loan || '')
            ].filter(Boolean).join('\n'));
            const location = encodeURIComponent(order.addr || '');
            const dates = formatGoogleDate(startDate) + '/' + formatGoogleDate(endDate);
            
            return `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&details=${details}&location=${location}&dates=${dates}`;
        }

        function formatPhone(value) {
            const numbers = value.replace(/\D/g, '');
            if (numbers.length <= 3) {
                return numbers;
            } else if (numbers.length <= 6) {
                return `(${numbers.slice(0, 3)}) ${numbers.slice(3)}`;
            } else {
                return `(${numbers.slice(0, 3)}) ${numbers.slice(3, 6)}-${numbers.slice(6, 10)}`;
            }
        }

        // Microsoft Authentication Configuration
        const msalConfig = {
            auth: {
                clientId: '89d0320b-597e-4405-8ccd-7beeb8e25566',
                authority: 'https://login.microsoftonline.com/consumers',
                redirectUri: 'https://bgoheen.github.io/orders'
            },
            cache: {
                cacheLocation: 'localStorage',
                storeAuthStateInCookie: false
            }
        };

        const msalInstance = new msal.PublicClientApplication(msalConfig);
        let msalAccount = null;
        let accessToken = null;

        const loginRequest = {
            scopes: ['Files.ReadWrite', 'User.Read', 'offline_access']
        };

        // Initialize MSAL
        msalInstance.initialize().then(() => {
            msalInstance.handleRedirectPromise().then(async response => {
                if (response) {
                    msalAccount = response.account;
                    await getAccessToken();
                    
                    // Only load from OneDrive if localStorage is empty
                    if (data.orders.length === 0) {
                        await loadOrdersFromOneDrive();
                    } else {
                        console.log('Using existing localStorage data, not loading from OneDrive');
                    }
                    
                    if (window.opener && !window.opener.closed) {
                        window.opener.postMessage('auth-complete', '*');
                        window.close();
                    }
                } else {
                    const accounts = msalInstance.getAllAccounts();
                    if (accounts.length > 0) {
                        msalAccount = accounts[0];
                        await getAccessToken();
                        
                        // Only load from OneDrive if localStorage is empty
                        if (data.orders.length === 0) {
                            await loadOrdersFromOneDrive();
                        } else {
                            console.log('Using existing localStorage data, not loading from OneDrive');
                        }
                    }
                }
                
                render();
            }).catch(err => {
                console.error('MSAL error:', err);
                render();
            });
        });

        window.addEventListener('message', (event) => {
            if (event.data === 'auth-complete') {
                window.location.reload();
            }
        });

        async function signIn() {
            try {
                await msalInstance.loginPopup(loginRequest);
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length > 0) {
                    msalAccount = accounts[0];
                    await getAccessToken();
                    
                    // Only load from OneDrive if localStorage is empty
                    if (data.orders.length === 0) {
                        await loadOrdersFromOneDrive();
                    } else {
                        console.log('Using existing localStorage data, not loading from OneDrive');
                    }
                    
                    render();
                }
            } catch (error) {
                console.error('Login error:', error);
            }
        }

        async function getAccessToken() {
            const request = {
                ...loginRequest,
                account: msalAccount
            };

            try {
                const response = await msalInstance.acquireTokenSilent(request);
                accessToken = response.accessToken;
                return accessToken;
            } catch (error) {
                if (error instanceof msal.InteractionRequiredAuthError) {
                    const response = await msalInstance.acquireTokenPopup(request);
                    accessToken = response.accessToken;
                    return accessToken;
                }
                throw error;
            }
        }

        async function uploadToOneDrive(file, orderId) {
            if (!accessToken) {
                await getAccessToken();
            }

            const fileName = `${orderId}_${file.name}`;
            const uploadUrl = `https://graph.microsoft.com/v1.0/me/drive/root:/AppraisalOrders/${fileName}:/content`;

            try {
                const response = await fetch(uploadUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': file.type
                    },
                    body: file
                });

                if (response.ok) {
                    const result = await response.json();
                    return {
                        id: result.id,
                        name: file.name,
                        date: new Date().toLocaleDateString(),
                        size: file.size,
                        webUrl: result.webUrl,
                        downloadUrl: result['@microsoft.graph.downloadUrl']
                    };
                } else {
                    throw new Error('Upload failed: ' + response.statusText);
                }
            } catch (error) {
                console.error('OneDrive upload error:', error);
                throw error;
            }
        }

        async function downloadFromOneDrive(fileId) {
            if (!accessToken) {
                await getAccessToken();
            }

            try {
                const response = await fetch(
                    `https://graph.microsoft.com/v1.0/me/drive/items/${fileId}`,
                    {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    }
                );

                if (response.ok) {
                    const fileInfo = await response.json();
                    window.open(fileInfo['@microsoft.graph.downloadUrl'], '_blank');
                } else {
                    throw new Error('Download failed: ' + response.statusText);
                }
            } catch (error) {
                console.error('OneDrive download error:', error);
                throw error;
            }
        }

        async function deleteFromOneDrive(fileId) {
            if (!accessToken) {
                await getAccessToken();
            }

            try {
                const response = await fetch(
                    `https://graph.microsoft.com/v1.0/me/drive/items/${fileId}`,
                    {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    }
                );

                if (!response.ok && response.status !== 404) {
                    throw new Error('Delete failed: ' + response.statusText);
                }
            } catch (error) {
                console.error('OneDrive delete error:', error);
                throw error;
            }
        }

        async function loadOrdersFromOneDrive() {
            if (!accessToken) return;

            const fileName = 'orders_data.json';
            const fileUrl = `https://graph.microsoft.com/v1.0/me/drive/root:/AppraisalOrders/${fileName}:/content`;

            try {
                const response = await fetch(fileUrl, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (response.ok) {
                    const jsonData = await response.json();
                    if (jsonData && jsonData.orders) {
                        data.orders = jsonData.orders;
                        data.nextNum = jsonData.nextNum || 1000;
                    }
                } else if (response.status === 404) {
                    console.log('No orders file found in OneDrive, starting fresh');
                } else {
                    console.error('Failed to load orders:', response.statusText);
                }
            } catch (error) {
                console.error('Error loading orders from OneDrive:', error);
            }
        }

        async function saveOrdersToOneDrive() {
            if (!accessToken) return;

            const fileName = 'orders_data.json';
            const uploadUrl = `https://graph.microsoft.com/v1.0/me/drive/root:/AppraisalOrders/${fileName}:/content`;

            const jsonData = JSON.stringify({
                orders: data.orders,
                nextNum: data.nextNum
            }, null, 2);

            try {
                const response = await fetch(uploadUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: jsonData
                });

                if (!response.ok) {
                    console.error('Failed to save orders:', response.statusText);
                }
            } catch (error) {
                console.error('Error saving orders to OneDrive:', error);
            }
        }

        const data = {
            orders: [],
            selected: null,
            filter: 'Ordered',
            search: '',
            tab: 'Orders',
            showNew: false,
            edit: false,
            nextNum: 1000,
            mapView: 'pins' // 'pins' or 'heatmap'
        };

        function save() {
            localStorage.setItem('orders', JSON.stringify({
                orders: data.orders,
                nextNum: data.nextNum
            }));
            
            if (msalAccount) {
                saveOrdersToOneDrive();
            }
        }

        function load() {
            const saved = localStorage.getItem('orders');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    
                    // Handle both old format (direct array/object) and new format (with orders property)
                    if (parsed.orders && Array.isArray(parsed.orders)) {
                        // New format: {orders: [...], nextNum: ...}
                        data.orders = parsed.orders;
                        data.nextNum = parsed.nextNum || 1000;
                    } else if (Array.isArray(parsed)) {
                        // Old format: direct array
                        data.orders = parsed;
                        data.nextNum = parsed.length > 0 ? parseInt(parsed[parsed.length - 1].num || 1000) + 1 : 1000;
                    } else if (typeof parsed === 'object') {
                        // Old format: object with numeric keys - convert to array
                        data.orders = Object.values(parsed).filter(item => item && item.id);
                        data.nextNum = data.orders.length > 0 ? parseInt(data.orders[data.orders.length - 1].num || 1000) + 1 : 1000;
                    }
                    
                    console.log('Loaded', data.orders.length, 'orders from localStorage');
                } catch (error) {
                    console.error('Error parsing localStorage orders:', error);
                }
            }
        }

        function genNumber() {
            const num = data.nextNum;
            data.nextNum++;
            return num.toString();
        }

        // Load from localStorage immediately
        load();
        console.log('Initial load complete. Orders:', data.orders.length);
        
        // Render immediately with localStorage data
        if (data.orders.length > 0) {
            console.log('Rendering with localStorage data');
            render();
        }

        function initializeMap() {
            if (!map) {
                const mapContainer = document.getElementById('map');
                if (!mapContainer) return;
                
                map = new google.maps.Map(mapContainer, {
                    center: { lat: 44.9537, lng: -93.0900 }, // Twin Cities center
                    zoom: 10,
                    styles: [
                        {
                            featureType: "poi",
                            elementType: "labels",
                            stylers: [{ visibility: "off" }]
                        }
                    ],
                    mapTypeControl: false,
                    streetViewControl: false,
                    fullscreenControl: true
                });
            }
            
            updateMap();
        }

        function updateMap() {
            if (!map) return;
            
            // Clear existing markers
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            
            // Clear existing heatmap
            if (heatmap) {
                heatmap.setMap(null);
                heatmap = null;
            }
            
            // Get completed orders with locations
            const completedOrders = data.orders.filter(o => 
                o.status === 'Completed' && o.lat && o.lng
            );
            
            if (completedOrders.length === 0) return;
            
            if (data.mapView === 'pins') {
                // Add markers
                completedOrders.forEach(order => {
                    const marker = new google.maps.Marker({
                        position: { lat: parseFloat(order.lat), lng: parseFloat(order.lng) },
                        map: map,
                        title: order.addr,
                        animation: google.maps.Animation.DROP
                    });
                    
                    const infoWindow = new google.maps.InfoWindow({
                        content: `
                            <div style="padding: 8px; min-width: 200px;">
                                <div style="font-weight: 600; margin-bottom: 4px;">${order.addr}</div>
                                <div style="font-size: 13px; color: #666;">
                                    <div>Order #${order.num || 'N/A'}</div>
                                    <div>${order.client || 'N/A'}</div>
                                    <div>Fee: $${order.fee || '0'}</div>
                                </div>
                            </div>
                        `
                    });
                    
                    marker.addListener('click', () => {
                        infoWindow.open(map, marker);
                    });
                    
                    markers.push(marker);
                });
                
                // Fit bounds to show all markers
                if (markers.length > 0) {
                    const bounds = new google.maps.LatLngBounds();
                    markers.forEach(marker => bounds.extend(marker.getPosition()));
                    map.fitBounds(bounds);
                    
                    // Prevent zoom from being too close on single marker
                    google.maps.event.addListenerOnce(map, 'bounds_changed', () => {
                        if (map.getZoom() > 15) {
                            map.setZoom(15);
                        }
                    });
                }
            } else if (data.mapView === 'heatmap') {
                // Create heatmap
                const heatmapData = completedOrders.map(order => {
                    return new google.maps.LatLng(
                        parseFloat(order.lat),
                        parseFloat(order.lng)
                    );
                });
                
                heatmap = new google.maps.visualization.HeatmapLayer({
                    data: heatmapData,
                    map: map,
                    radius: 30,
                    opacity: 0.6
                });
                
                // Fit bounds to show all points
                const bounds = new google.maps.LatLngBounds();
                heatmapData.forEach(point => bounds.extend(point));
                map.fitBounds(bounds);
            }
        }

        function toggleMapView() {
            data.mapView = data.mapView === 'pins' ? 'heatmap' : 'pins';
            updateMap();
            render();
        }

        function render() {
            const filtered = data.orders.filter(o => {
                const matchStatus = o.status === data.filter;
                const matchSearch = !data.search || 
                    o.addr.toLowerCase().includes(data.search.toLowerCase()) ||
                    (o.client && o.client.toLowerCase().includes(data.search.toLowerCase())) ||
                    (o.num && o.num.includes(data.search));
                return matchStatus && matchSearch;
            });

            const ordered = data.orders.filter(o => o.status === 'Ordered').length;
            const completed = data.orders.filter(o => o.status === 'Completed').length;
            const cancelled = data.orders.filter(o => o.status === 'Cancelled').length;

            // Calculate metrics
            const thisMonth = new Date();
            thisMonth.setDate(1);
            thisMonth.setHours(0, 0, 0, 0);
            
            const thisMonthOrders = data.orders.filter(o => {
                if (!o.created) return false;
                const orderDate = new Date(o.created);
                return orderDate >= thisMonth;
            });
            
            const thisMonthRevenue = thisMonthOrders
                .filter(o => o.status === 'Completed')
                .reduce((sum, o) => sum + (parseFloat(o.fee) || 0), 0);
            
            const completedWithFees = data.orders.filter(o => 
                o.status === 'Completed' && o.fee && parseFloat(o.fee) > 0
            );
            
            const avgFee = completedWithFees.length > 0
                ? completedWithFees.reduce((sum, o) => sum + parseFloat(o.fee), 0) / completedWithFees.length
                : 0;

            document.getElementById('app').innerHTML = `
                <div class="max-w-7xl mx-auto p-6">
                    <!-- Header -->
                    <div class="flex items-center justify-between mb-8">
                        <div>
                            <h1 class="text-3xl font-semibold text-gray-900">Appraisal Orders</h1>
                            ${msalAccount ? `
                                <div class="flex items-center gap-2 mt-1">
                                    <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                                    <span class="text-sm text-gray-600">Connected to OneDrive</span>
                                </div>
                            ` : `
                                <button 
                                    onclick="signIn()" 
                                    class="mt-2 text-sm text-blue-600 hover:text-blue-700 font-medium"
                                >
                                    Connect OneDrive
                                </button>
                            `}
                        </div>
                        <div class="flex items-center gap-3">
                            <button 
                                onclick="data.tab = 'Orders'; render();" 
                                class="px-4 py-2 rounded-lg font-medium transition-all ${
                                    data.tab === 'Orders' 
                                        ? 'bg-gray-900 text-white' 
                                        : 'bg-white text-gray-700 hover:bg-gray-50'
                                }"
                            >
                                <span class="flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                    Orders
                                </span>
                            </button>
                            <button 
                                onclick="data.tab = 'Metrics'; render(); setTimeout(initializeMap, 100);" 
                                class="px-4 py-2 rounded-lg font-medium transition-all ${
                                    data.tab === 'Metrics' 
                                        ? 'bg-gray-900 text-white' 
                                        : 'bg-white text-gray-700 hover:bg-gray-50'
                                }"
                            >
                                <span class="flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                    </svg>
                                    Metrics
                                </span>
                            </button>
                        </div>
                    </div>

                    ${data.tab === 'Orders' ? `
                        <!-- Orders View -->
                        <div class="mb-6">
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex-1 max-w-md">
                                    <div class="relative">
                                        <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                        </svg>
                                        <input 
                                            type="text" 
                                            placeholder="Search orders..." 
                                            value="${data.search}"
                                            oninput="data.search = this.value; render();"
                                            class="w-full pl-10 pr-4 py-2.5 bg-white border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-transparent"
                                        >
                                    </div>
                                </div>
                                <button 
                                    onclick="data.showNew = true; render();" 
                                    class="ml-4 px-5 py-2.5 bg-gray-900 text-white rounded-lg hover:bg-gray-800 transition-all font-medium flex items-center gap-2 shadow-sm"
                                >
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                    </svg>
                                    New Order
                                </button>
                            </div>

                            <!-- Status Tabs -->
                            <div class="flex gap-2 mb-6">
                                ${['Ordered', 'Completed', 'Cancelled'].map(status => {
                                    const count = status === 'Ordered' ? ordered : status === 'Completed' ? completed : cancelled;
                                    const isActive = data.filter === status;
                                    return `
                                        <button 
                                            onclick="data.filter = '${status}'; render();"
                                            class="px-4 py-2 rounded-lg font-medium transition-all ${
                                                isActive
                                                    ? 'bg-white shadow-sm border border-gray-200'
                                                    : 'text-gray-600 hover:text-gray-900 hover:bg-gray-50'
                                            }"
                                        >
                                            ${status}
                                            <span class="ml-2 inline-flex items-center justify-center w-6 h-6 text-xs font-semibold rounded-full ${
                                                isActive ? 'bg-gray-900 text-white' : 'bg-gray-100 text-gray-600'
                                            }">
                                                ${count}
                                            </span>
                                        </button>
                                    `;
                                }).join('')}
                            </div>

                            <!-- Orders Grid -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                ${filtered.map(o => `
                                    <div class="order-card bg-white rounded-xl p-5 border border-gray-200 cursor-pointer relative"
                                         onclick="data.selected = ${JSON.stringify(o).replace(/"/g, '&quot;')}; data.edit = false; render();">
                                        <!-- Status Badge -->
                                        <div class="absolute top-4 right-4">
                                            <span class="status-badge status-${o.status.toLowerCase()}">
                                                ${o.status}
                                            </span>
                                        </div>
                                        
                                        <!-- Order Content -->
                                        <div class="pr-20">
                                            <h3 class="text-base font-semibold text-gray-900 mb-1 line-clamp-2">
                                                ${o.addr}
                                            </h3>
                                            <p class="text-sm text-gray-500 mb-3">
                                                ${o.city || ''}, ${o.state || ''} ${o.zip || ''}
                                            </p>
                                        </div>
                                        
                                        <!-- Order Details -->
                                        <div class="space-y-2 mt-4 pt-4 border-t border-gray-100">
                                            <div class="flex items-center justify-between text-sm">
                                                <span class="text-gray-500 flex items-center gap-1.5">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                                    </svg>
                                                    ${o.client || 'No client'}
                                                </span>
                                            </div>
                                            <div class="flex items-center justify-between text-sm">
                                                <span class="text-gray-500 flex items-center gap-1.5">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                                                    </svg>
                                                    Order #${o.num || 'N/A'}
                                                </span>
                                            </div>
                                            ${o.fee ? `
                                                <div class="flex items-center justify-between text-sm">
                                                    <span class="text-gray-500 flex items-center gap-1.5">
                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                        </svg>
                                                        $${o.fee}
                                                    </span>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            ${filtered.length === 0 ? `
                                <div class="text-center py-16">
                                    <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                    <p class="text-gray-500 text-lg">No ${data.filter.toLowerCase()} orders</p>
                                </div>
                            ` : ''}
                        </div>
                    ` : `
                        <!-- Metrics View -->
                        <div class="space-y-6">
                            <!-- Stats Cards -->
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div class="bg-white rounded-xl p-6 border border-gray-200">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-sm font-medium text-gray-500">Active Orders</span>
                                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                    </div>
                                    <div class="text-3xl font-semibold text-gray-900">${ordered}</div>
                                </div>
                                
                                <div class="bg-white rounded-xl p-6 border border-gray-200">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-sm font-medium text-gray-500">This Month</span>
                                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                                        </svg>
                                    </div>
                                    <div class="text-3xl font-semibold text-gray-900">${thisMonthOrders.length}</div>
                                    <div class="text-xs text-gray-500 mt-1">$${thisMonthRevenue.toFixed(0)} revenue</div>
                                </div>
                                
                                <div class="bg-white rounded-xl p-6 border border-gray-200">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-sm font-medium text-gray-500">Total Completed</span>
                                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                    </div>
                                    <div class="text-3xl font-semibold text-gray-900">${completed}</div>
                                </div>
                                
                                <div class="bg-white rounded-xl p-6 border border-gray-200">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-sm font-medium text-gray-500">Avg Fee</span>
                                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                    </div>
                                    <div class="text-3xl font-semibold text-gray-900">$${Math.round(avgFee)}</div>
                                    <div class="text-xs text-gray-500 mt-1">$${(avgFee * completed).toFixed(0)} total</div>
                                </div>
                            </div>

                            <!-- Map Section -->
                            <div class="bg-white rounded-xl p-6 border border-gray-200">
                                <div class="flex items-center justify-between mb-4">
                                    <div>
                                        <h2 class="text-lg font-semibold text-gray-900">Completed Appraisals Map</h2>
                                        <p class="text-sm text-gray-500 mt-1">
                                            ${completed} location${completed !== 1 ? 's' : ''}
                                        </p>
                                    </div>
                                    <div class="flex items-center gap-2 bg-gray-100 rounded-lg p-1">
                                        <button
                                            onclick="if(data.mapView !== 'pins') toggleMapView();"
                                            class="px-4 py-2 rounded-md text-sm font-medium transition-all ${
                                                data.mapView === 'pins'
                                                    ? 'bg-white text-gray-900 shadow-sm'
                                                    : 'text-gray-600 hover:text-gray-900'
                                            }"
                                        >
                                            <span class="flex items-center gap-2">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                                </svg>
                                                Pins
                                            </span>
                                        </button>
                                        <button
                                            onclick="if(data.mapView !== 'heatmap') toggleMapView();"
                                            class="px-4 py-2 rounded-md text-sm font-medium transition-all ${
                                                data.mapView === 'heatmap'
                                                    ? 'bg-white text-gray-900 shadow-sm'
                                                    : 'text-gray-600 hover:text-gray-900'
                                            }"
                                        >
                                            <span class="flex items-center gap-2">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                                </svg>
                                                Heatmap
                                            </span>
                                        </button>
                                    </div>
                                </div>
                                <div id="map"></div>
                                ${completed === 0 ? `
                                    <div class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-90 rounded-xl">
                                        <div class="text-center">
                                            <svg class="w-16 h-16 mx-auto text-gray-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
                                            </svg>
                                            <p class="text-gray-500">No completed orders with location data</p>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>

                            <!-- Charts Section (preserved from original) -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <!-- Revenue Chart -->
                                <div class="bg-white rounded-xl p-6 border border-gray-200">
                                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Revenue (Last 12 Months)</h3>
                                    <canvas id="revenueChart" style="max-height: 300px;"></canvas>
                                </div>
                                
                                <!-- Top Clients Chart -->
                                <div class="bg-white rounded-xl p-6 border border-gray-200">
                                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Top Clients</h3>
                                    <canvas id="clientsChart" style="max-height: 300px;"></canvas>
                                </div>
                            </div>
                        </div>
                    `}
                </div>

                ${data.selected ? renderDetailModal() : ''}
                ${data.showNew ? renderNewOrderModal() : ''}
            `;

            // Initialize charts if on metrics tab
            if (data.tab === 'Metrics') {
                setTimeout(() => {
                    renderCharts();
                }, 100);
            }
        }

        function renderCharts() {
            // Revenue Chart
            const revenueCtx = document.getElementById('revenueChart');
            if (revenueCtx) {
                const months = [];
                const revenue = [];
                const now = new Date();
                
                for (let i = 11; i >= 0; i--) {
                    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    months.push(d.toLocaleDateString('en-US', { month: 'short' }));
                    
                    const monthRevenue = data.orders
                        .filter(o => {
                            if (!o.created || o.status !== 'Completed') return false;
                            const orderDate = new Date(o.created);
                            return orderDate.getMonth() === d.getMonth() && 
                                   orderDate.getFullYear() === d.getFullYear();
                        })
                        .reduce((sum, o) => sum + (parseFloat(o.fee) || 0), 0);
                    
                    revenue.push(monthRevenue);
                }
                
                new Chart(revenueCtx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Revenue',
                            data: revenue,
                            borderColor: '#111827',
                            backgroundColor: 'rgba(17, 24, 39, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: value => '$' + value.toLocaleString()
                                }
                            }
                        }
                    }
                });
            }
            
            // Top Clients Chart
            const clientsCtx = document.getElementById('clientsChart');
            if (clientsCtx) {
                const clientCounts = {};
                data.orders
                    .filter(o => o.status === 'Completed' && o.client)
                    .forEach(o => {
                        clientCounts[o.client] = (clientCounts[o.client] || 0) + 1;
                    });
                
                const sortedClients = Object.entries(clientCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);
                
                new Chart(clientsCtx, {
                    type: 'bar',
                    data: {
                        labels: sortedClients.map(c => c[0]),
                        datasets: [{
                            label: 'Orders',
                            data: sortedClients.map(c => c[1]),
                            backgroundColor: '#111827',
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            }
        }

        function renderDetailModal() {
            const o = data.selected;
            if (!o) return '';

            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="if(event.target === this) { data.selected = null; render(); }">
                    <div class="bg-white rounded-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation();">
                        <!-- Modal Header -->
                        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between rounded-t-2xl z-10">
                            <div class="flex items-center gap-3">
                                <h2 class="text-xl font-semibold text-gray-900">Order Details</h2>
                                <span class="status-badge status-${o.status.toLowerCase()}">
                                    ${o.status}
                                </span>
                            </div>
                            <div class="flex items-center gap-2">
                                ${!data.edit ? `
                                    <button onclick="data.edit = true; render();" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                        </svg>
                                    </button>
                                ` : ''}
                                <button onclick="data.selected = null; data.edit = false; render();" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <!-- Modal Content -->
                        <div class="p-6">
                            ${data.edit ? `
                                <!-- Edit Form -->
                                <div class="space-y-6">
                                    <!-- Property Info -->
                                    <div>
                                        <h3 class="text-sm font-semibold text-gray-900 mb-3">Property Information</h3>
                                        <div class="grid grid-cols-2 gap-4">
                                            <div class="col-span-2">
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Address</label>
                                                <input type="text" id="edit-addr" value="${o.addr || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">City</label>
                                                <input type="text" id="edit-city" value="${o.city || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">State</label>
                                                <input type="text" id="edit-state" value="${o.state || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">ZIP</label>
                                                <input type="text" id="edit-zip" value="${o.zip || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Fee</label>
                                                <input type="number" id="edit-fee" value="${o.fee || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Client Info -->
                                    <div>
                                        <h3 class="text-sm font-semibold text-gray-900 mb-3">Client Information</h3>
                                        <div class="grid grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Client</label>
                                                <input type="text" id="edit-client" value="${o.client || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Borrower</label>
                                                <input type="text" id="edit-borrower" value="${o.borrower || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">POC</label>
                                                <input type="text" id="edit-poc" value="${o.poc || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                                                <input type="tel" id="edit-phone" value="${o.phone || ''}" oninput="this.value = formatPhone(this.value);" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900">
                                            </div>
                                            <div class="col-span-2">
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                                <input type="email" id="edit-email" value="${o.email || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Loan #</label>
                                                <input type="text" id="edit-loan" value="${o.loan || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Inspection Date & Time -->
                                    <div>
                                        <h3 class="text-sm font-semibold text-gray-900 mb-3">Inspection Schedule</h3>
                                        <div class="grid grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                                                <input type="date" id="edit-startDate" value="${o.startDate || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Time</label>
                                                <input type="time" id="edit-startTime" value="${o.startTime || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Notes -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                                        <textarea id="edit-desc" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900">${o.desc || ''}</textarea>
                                    </div>

                                    <!-- Action Buttons -->
                                    <div class="flex items-center justify-between pt-4 border-t border-gray-200">
                                        <button onclick="deleteOrder('${o.id}')" class="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors font-medium">
                                            Delete Order
                                        </button>
                                        <div class="flex gap-3">
                                            <button onclick="data.edit = false; render();" class="px-5 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium">
                                                Cancel
                                            </button>
                                            <button onclick="saveEdit('${o.id}')" class="px-5 py-2 bg-gray-900 text-white rounded-lg hover:bg-gray-800 transition-colors font-medium">
                                                Save Changes
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            ` : `
                                <!-- View Mode -->
                                <div class="space-y-6">
                                    <!-- Property Details -->
                                    <div>
                                        <h3 class="text-sm font-semibold text-gray-900 mb-3">Property</h3>
                                        <div class="space-y-2">
                                            <p class="text-base text-gray-900">${o.addr}</p>
                                            <p class="text-sm text-gray-600">${[o.city, o.state, o.zip].filter(Boolean).join(', ')}</p>
                                            ${o.fee ? `<p class="text-sm text-gray-600">Fee: <span class="font-medium">$${o.fee}</span></p>` : ''}
                                        </div>
                                    </div>

                                    <!-- Client Details -->
                                    ${(o.client || o.borrower || o.poc || o.phone || o.email || o.loan) ? `
                                        <div class="pt-4 border-t border-gray-200">
                                            <h3 class="text-sm font-semibold text-gray-900 mb-3">Contact Information</h3>
                                            <div class="grid grid-cols-2 gap-4">
                                                ${o.client ? `<div><span class="text-sm text-gray-500">Client</span><p class="text-sm text-gray-900 mt-1">${o.client}</p></div>` : ''}
                                                ${o.borrower ? `<div><span class="text-sm text-gray-500">Borrower</span><p class="text-sm text-gray-900 mt-1">${o.borrower}</p></div>` : ''}
                                                ${o.poc ? `<div><span class="text-sm text-gray-500">POC</span><p class="text-sm text-gray-900 mt-1">${o.poc}</p></div>` : ''}
                                                ${o.phone ? `<div><span class="text-sm text-gray-500">Phone</span><p class="text-sm text-gray-900 mt-1">${o.phone}</p></div>` : ''}
                                                ${o.email ? `<div class="col-span-2"><span class="text-sm text-gray-500">Email</span><p class="text-sm text-gray-900 mt-1">${o.email}</p></div>` : ''}
                                                ${o.loan ? `<div><span class="text-sm text-gray-500">Loan #</span><p class="text-sm text-gray-900 mt-1">${o.loan}</p></div>` : ''}
                                            </div>
                                        </div>
                                    ` : ''}

                                    <!-- Inspection Schedule -->
                                    ${(o.startDate || o.startTime) ? `
                                        <div class="pt-4 border-t border-gray-200">
                                            <h3 class="text-sm font-semibold text-gray-900 mb-3">Inspection</h3>
                                            <div class="flex items-center gap-4">
                                                ${o.startDate ? `<p class="text-sm text-gray-900">${new Date(o.startDate).toLocaleDateString()}</p>` : ''}
                                                ${o.startTime ? `<p class="text-sm text-gray-900">${o.startTime}</p>` : ''}
                                                ${(o.startDate && o.startTime) ? `
                                                    <a href="${createGoogleCalendarLink(o)}" target="_blank" class="text-sm text-blue-600 hover:text-blue-700 font-medium">
                                                        Add to Calendar
                                                    </a>
                                                ` : ''}
                                            </div>
                                        </div>
                                    ` : ''}

                                    <!-- Notes -->
                                    ${o.desc ? `
                                        <div class="pt-4 border-t border-gray-200">
                                            <h3 class="text-sm font-semibold text-gray-900 mb-2">Notes</h3>
                                            <p class="text-sm text-gray-700 whitespace-pre-wrap">${o.desc}</p>
                                        </div>
                                    ` : ''}

                                    <!-- Attachments -->
                                    ${o.att && o.att.length > 0 ? `
                                        <div class="pt-4 border-t border-gray-200">
                                            <h3 class="text-sm font-semibold text-gray-900 mb-3">Attachments (${o.att.length})</h3>
                                            <div class="space-y-2">
                                                ${o.att.map(f => `
                                                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                                                        <div class="flex items-center gap-3 flex-1 min-w-0">
                                                            <svg class="w-5 h-5 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                                                            </svg>
                                                            <span class="text-sm text-gray-900 truncate">${f.name}</span>
                                                        </div>
                                                        <div class="flex items-center gap-2 flex-shrink-0 ml-4">
                                                            <button onclick="downloadFromOneDrive('${f.id}')" class="p-1.5 hover:bg-gray-200 rounded transition-colors">
                                                                <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                                                </svg>
                                                            </button>
                                                            <button onclick="deleteFile('${o.id}', '${f.id}')" class="p-1.5 hover:bg-red-100 rounded transition-colors">
                                                                <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                                </svg>
                                                            </button>
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    ` : ''}

                                    ${msalAccount ? `
                                        <div class="pt-4 border-t border-gray-200">
                                            <label class="block text-sm font-semibold text-gray-900 mb-3">Upload Files</label>
                                            <div class="flex items-center gap-3">
                                                <button onclick="document.getElementById('file-upload-${o.id}').click()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors font-medium">
                                                    Choose Files
                                                </button>
                                                <input 
                                                    type="file" 
                                                    id="file-upload-${o.id}" 
                                                    multiple 
                                                    onchange="uploadFiles(event, '${o.id}')" 
                                                    class="hidden"
                                                >
                                            </div>
                                        </div>
                                    ` : ''}

                                    <!-- Status Actions -->
                                    <div class="pt-4 border-t border-gray-200">
                                        <div class="flex gap-3">
                                            ${o.status === 'Ordered' ? `
                                                <button onclick="updateStatus('${o.id}', 'Completed')" class="flex-1 px-4 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium">
                                                    Mark Completed
                                                </button>
                                                <button onclick="updateStatus('${o.id}', 'Cancelled')" class="flex-1 px-4 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium">
                                                    Mark Cancelled
                                                </button>
                                            ` : o.status === 'Completed' ? `
                                                <button onclick="updateStatus('${o.id}', 'Ordered')" class="flex-1 px-4 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium">
                                                    Mark Ordered
                                                </button>
                                            ` : `
                                                <button onclick="updateStatus('${o.id}', 'Ordered')" class="flex-1 px-4 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium">
                                                    Mark Ordered
                                                </button>
                                            `}
                                        </div>
                                    </div>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderNewOrderModal() {
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="if(event.target === this) { data.showNew = false; render(); }">
                    <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation();">
                        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between rounded-t-2xl">
                            <h2 class="text-xl font-semibold text-gray-900">New Order</h2>
                            <button onclick="data.showNew = false; render();" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>

                        <div class="p-6 space-y-6">
                            <!-- Property Info -->
                            <div>
                                <h3 class="text-sm font-semibold text-gray-900 mb-3">Property Information</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="col-span-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Address *</label>
                                        <input 
                                            type="text" 
                                            id="new-addr" 
                                            placeholder="123 Main St"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900"
                                        >
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">City</label>
                                        <input type="text" id="new-city" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">State</label>
                                        <input type="text" id="new-state" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">ZIP</label>
                                        <input type="text" id="new-zip" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Fee</label>
                                        <input type="number" id="new-fee" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900">
                                    </div>
                                </div>
                            </div>

                            <!-- Client Info -->
                            <div>
                                <h3 class="text-sm font-semibold text-gray-900 mb-3">Client Information</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Client</label>
                                        <input type="text" id="new-client" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Borrower</label>
                                        <input type="text" id="new-borrower" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">POC</label>
                                        <input type="text" id="new-poc" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                                        <input 
                                            type="tel" 
                                            id="new-phone" 
                                            oninput="this.value = formatPhone(this.value);"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900"
                                        >
                                    </div>
                                    <div class="col-span-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                        <input type="email" id="new-email" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Loan #</label>
                                        <input type="text" id="new-loan" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900">
                                    </div>
                                </div>
                            </div>

                            <!-- Inspection Schedule -->
                            <div>
                                <h3 class="text-sm font-semibold text-gray-900 mb-3">Inspection Schedule</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                                        <input type="date" id="new-startDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Time</label>
                                        <input type="time" id="new-startTime" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900">
                                    </div>
                                </div>
                            </div>

                            ${msalAccount ? `
                                <div>
                                    <label class="block text-sm font-semibold text-gray-900 mb-2">Upload Files</label>
                                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-gray-400 transition-colors">
                                        <button onclick="document.getElementById('new-file-upload').click()" class="text-sm text-gray-600 hover:text-gray-900 font-medium">
                                            Click to upload files
                                        </button>
                                        <input 
                                            type="file" 
                                            id="new-file-upload" 
                                            multiple 
                                            onchange="handleNewFileSelect(event)"
                                            class="hidden"
                                        >
                                        <div id="new-files-list" class="mt-3 text-sm text-gray-500"></div>
                                    </div>
                                </div>
                            ` : ''}

                            <!-- Action Buttons -->
                            <div class="flex justify-end gap-3 pt-4 border-t border-gray-200">
                                <button onclick="data.showNew = false; render();" class="px-5 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium">
                                    Cancel
                                </button>
                                <button onclick="createOrder()" class="px-5 py-2 bg-gray-900 text-white rounded-lg hover:bg-gray-800 transition-colors font-medium">
                                    Create Order
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function handleNewFileSelect(e) {
            const files = Array.from(e.target.files);
            const filesList = document.getElementById('new-files-list');
            if (files.length > 0) {
                filesList.innerHTML = files.map(f => `<div>${f.name}</div>`).join('');
            }
        }

        function updateStatus(id, newStatus) {
            const order = data.orders.find(o => o.id === id);
            if (order) {
                order.status = newStatus;
                save();
                data.selected = order;
                render();
            }
        }

        function saveEdit(id) {
            const order = data.orders.find(o => o.id === id);
            if (!order) return;

            const addr = document.getElementById('edit-addr').value;
            if (!addr.trim()) {
                alert('Address is required');
                return;
            }

            order.addr = addr;
            order.city = document.getElementById('edit-city').value;
            order.state = document.getElementById('edit-state').value;
            order.zip = document.getElementById('edit-zip').value;
            order.fee = document.getElementById('edit-fee').value;
            order.client = document.getElementById('edit-client').value;
            order.borrower = document.getElementById('edit-borrower').value;
            order.poc = document.getElementById('edit-poc').value;
            order.phone = document.getElementById('edit-phone').value;
            order.email = document.getElementById('edit-email').value;
            order.loan = document.getElementById('edit-loan').value;
            order.startDate = document.getElementById('edit-startDate').value;
            order.startTime = document.getElementById('edit-startTime').value;
            order.desc = document.getElementById('edit-desc').value;

            // Geocode the new address
            const fullAddress = `${order.addr}, ${order.city}, ${order.state} ${order.zip}`;
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ address: fullAddress }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    order.lat = results[0].geometry.location.lat();
                    order.lng = results[0].geometry.location.lng();
                }
                
                save();
                data.selected = order;
                data.edit = false;
                render();
            });
        }

        async function createOrder() {
            const addr = document.getElementById('new-addr').value;
            
            if (!addr.trim()) {
                alert('Address is required');
                return;
            }

            const newOrder = {
                id: Date.now().toString(),
                status: 'Ordered',
                created: new Date().toISOString(),
                addr: addr,
                city: document.getElementById('new-city').value,
                state: document.getElementById('new-state').value,
                zip: document.getElementById('new-zip').value,
                fee: document.getElementById('new-fee').value,
                client: document.getElementById('new-client').value,
                borrower: document.getElementById('new-borrower').value,
                poc: document.getElementById('new-poc').value,
                phone: document.getElementById('new-phone').value,
                email: document.getElementById('new-email').value,
                loan: document.getElementById('new-loan').value,
                startDate: document.getElementById('new-startDate').value,
                startTime: document.getElementById('new-startTime').value,
                num: genNumber(),
                desc: '',
                att: []
            };

            // Geocode the address
            const fullAddress = `${newOrder.addr}, ${newOrder.city}, ${newOrder.state} ${newOrder.zip}`;
            const geocoder = new google.maps.Geocoder();
            
            geocoder.geocode({ address: fullAddress }, async (results, status) => {
                if (status === 'OK' && results[0]) {
                    newOrder.lat = results[0].geometry.location.lat();
                    newOrder.lng = results[0].geometry.location.lng();
                }
                
                // Handle file uploads
                const fileInput = document.getElementById('new-file-upload');
                if (fileInput && fileInput.files.length > 0 && msalAccount) {
                    const files = Array.from(fileInput.files);
                    const createButton = document.querySelector('button[onclick="createOrder()"]');
                    const originalText = createButton.innerHTML;
                    
                    const progressContainer = document.createElement('div');
                    progressContainer.id = 'new-upload-progress';
                    progressContainer.className = 'mt-3 w-full';
                    progressContainer.innerHTML = `
                        <div class="flex justify-between text-xs text-gray-600 mb-1">
                            <span id="new-upload-status">Uploading files...</span>
                            <span id="new-upload-percent">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                            <div id="new-upload-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    `;
                    const newFilesList = document.getElementById('new-files-list');
                    if (newFilesList) {
                        newFilesList.after(progressContainer);
                    }
                    
                    createButton.disabled = true;
                    createButton.classList.add('opacity-50', 'cursor-not-allowed');
                    
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        try {
                            const statusEl = document.getElementById('new-upload-status');
                            const percentEl = document.getElementById('new-upload-percent');
                            const progressBar = document.getElementById('new-upload-bar');
                            
                            if (statusEl) statusEl.textContent = `Uploading ${file.name} (${i + 1} of ${files.length})`;
                            const percent = Math.round(((i) / files.length) * 100);
                            if (percentEl) percentEl.textContent = `${percent}%`;
                            if (progressBar) progressBar.style.width = `${percent}%`;
                            
                            const uploadedFile = await uploadToOneDrive(file, newOrder.id);
                            newOrder.att.push(uploadedFile);
                        } catch (error) {
                            console.error('Failed to upload file:', error);
                            alert(`Failed to upload ${file.name}`);
                        }
                    }
                    
                    const percentEl = document.getElementById('new-upload-percent');
                    const progressBar = document.getElementById('new-upload-bar');
                    if (percentEl) percentEl.textContent = '100%';
                    if (progressBar) progressBar.style.width = '100%';
                    
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                data.orders.push(newOrder);
                save();
                data.showNew = false;
                render();
            });
        }

        async function deleteOrder(id) {
            if (confirm('Delete this order?')) {
                data.orders = data.orders.filter(o => o.id !== id);
                save();
                data.selected = null;
                render();
            }
        }

        async function uploadFiles(e, orderId) {
            if (!msalAccount) {
                alert('Please sign in to OneDrive to upload files');
                return;
            }

            const files = Array.from(e.target.files);
            if (files.length === 0) return;

            const order = data.orders.find(o => o.id === orderId);
            if (!order) return;

            if (!order.att) order.att = [];

            const uploadButton = e.target.previousElementSibling;
            const originalText = uploadButton.innerHTML;
            const progressContainer = document.createElement('div');
            progressContainer.className = 'mt-3 w-full';
            progressContainer.innerHTML = `
                <div class="flex justify-between text-xs text-gray-600 mb-1">
                    <span id="upload-status">Uploading files...</span>
                    <span id="upload-percent">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                    <div id="upload-progress" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            `;
            uploadButton.parentElement.appendChild(progressContainer);
            uploadButton.disabled = true;
            uploadButton.classList.add('opacity-50', 'cursor-not-allowed');
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                try {
                    const statusEl = document.getElementById('upload-status');
                    const percentEl = document.getElementById('upload-percent');
                    const progressBar = document.getElementById('upload-progress');
                    
                    if (statusEl) statusEl.textContent = `Uploading ${file.name} (${i + 1} of ${files.length})`;
                    const percent = Math.round(((i) / files.length) * 100);
                    if (percentEl) percentEl.textContent = `${percent}%`;
                    if (progressBar) progressBar.style.width = `${percent}%`;
                    
                    const uploadedFile = await uploadToOneDrive(file, orderId);
                    order.att.push(uploadedFile);
                } catch (error) {
                    alert(`Failed to upload ${file.name}: ${error.message}`);
                }
            }
            
            const percentEl = document.getElementById('upload-percent');
            const progressBar = document.getElementById('upload-progress');
            if (percentEl) percentEl.textContent = '100%';
            if (progressBar) progressBar.style.width = '100%';
            
            setTimeout(() => {
                if (progressContainer.parentElement) {
                    progressContainer.remove();
                }
                uploadButton.innerHTML = originalText;
                uploadButton.disabled = false;
                uploadButton.classList.remove('opacity-50', 'cursor-not-allowed');
                
                save();
                if (data.selected && data.selected.id === orderId) {
                    data.selected = order;
                }
                render();
            }, 500);
        }

        async function deleteFile(orderId, fileId) {
            if (!confirm('Delete this file?')) return;

            try {
                await deleteFromOneDrive(fileId);
                
                const order = data.orders.find(o => o.id === orderId);
                if (order && order.att) {
                    order.att = order.att.filter(f => f.id !== fileId);
                    save();
                    if (data.selected && data.selected.id === orderId) {
                        data.selected = order;
                    }
                    render();
                }
            } catch (error) {
                alert('Failed to delete file: ' + error.message);
            }
        }

        // Clean up old Google Calendar tokens if they exist
        localStorage.removeItem('googleAccessToken');
        localStorage.removeItem('googleTokenExpiry');

        render();
    </script>
</body>
</html>
